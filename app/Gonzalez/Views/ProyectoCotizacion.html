{% include 'header.html' %}
{% include 'menu.html' %}

<div class="container">
  {% for proyecto in proyectos %}
  <div class="page-header">
    <div class="col-xs-6">
      <h2>{{ proyecto.clave|trim }}<small>{{ proyecto.titulo|trim }}</small></h2>
      <h4>{{ proyecto.estatus|trim }}</h4>
    </div>
    <div class="col-xs-6">
      <h6>{{ proyecto.resumen|trim }}</h6>
    </div>
  </div>
  <input type="hidden" id="idProyecto" value="{{proyecto.idProyecto}}">
  <input type="hidden" id="cantidadLh" value="{{proyecto.cantidadLh}}">
  <input type="hidden" id="cantidadRh" value="{{proyecto.cantidadRh}}">
  {% endfor %}
	</div>


	<div class="row">
    <div class="col-xs-6">
      <button type="button" class="btn btn-default" onclick="$.redirect(BASE_URL + 'gonzalez/proyectos',{idProyecto:$('#idProyecto').val()}, 'POST');"><i class="fa fa-arrow-circle-o-left" aria-hidden="true"><span> Regresar</span></i></button>
    </div>
    <div class="col-xs-6">
    </div>
  </div>
  
  <hr>

  <div class="row">
    <div class="col-xs-10"></div>
    <div class="col-xs-2">
      <button type="button" class="btn btn-success" onclick="guardar($('#idProyecto').val());"><i class="fa fa-hdd-o" aria-hidden="true"><span> Guardar</span></i></button>
    </div>
	</div>

  <hr>

	<div class="row">
    <div class="col-xs-12">
		  <div id="grid-venta" class="handsontable"></div>
    </div>
	</div>

  <hr>

  <div class="row">
    <div class="col-xs-4"><strong>Cut&Fit:</strong><span class="cutFit"></span></div>
    <div class="col-xs-4"><strong>NC Mach:</strong><span class="ncMach"></span></div>
    <div class="col-xs-4"><strong>Mach:</strong><span class="conventionalMach"></span></div>
  </div>
  <div class="row">
    <div class="col-xs-4"><strong>Welding:</strong><span class="welding"></span></div>
    <div class="col-xs-4"><strong>Finishing:</strong><span class="finishing"></span></div>
    <div class="col-xs-4"><strong>Assy Packing:</strong><span class="assyPacking"></span></div>
  </div>
  <div class="row">
    <div class="col-xs-4"><strong>Laser Service:</strong><span class="laserService"></span></div>
    <div class="col-xs-4"><strong>Installation:<span class="installation"></span></div>
  </div>

</div>

<div id="modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 id="modal-titulo" class="modal-title">Buscar producto</h4>
      </div>
      <div class="modal-body">
        <input type="hidden" id="fila-actual">
        <table id="tabla-productos"></table>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
var
  grid = document.getElementById('grid-venta'),
  hot,
  data = [
    {% for data in productos %}
      ['{{data.seccion}}', {{data.hoja}}, {{data.det}}, {{data.subDet}}, '{{data.producto}}', '{{data.descripcion}}', {{data.kgm}}, {{data.kgpzs}}, {{data.cant}}, {{data.lng}}, {{data.scrap}}, {{data.pesoTotal}}, {{data.precio}}, {{data.cutFit}}, {{data.ncMach}}, {{data.conventionalMach}}, {{data.welding}}, {{data.finishing}}, {{data.assyPacking}}, {{data.laserService}}, {{data.installation}}],
    {% endfor %}];
crearTabla();
var fila = 0;
$(data).each(function() {
  hot.setDataAtCell(fila, 0, data[fila][0]);
  hot.setDataAtCell(fila, 1, data[fila][1]);
  hot.setDataAtCell(fila, 2, data[fila][2]);
  hot.setDataAtCell(fila, 3, data[fila][3]);
  hot.setDataAtCell(fila, 4, data[fila][4]);
  hot.setDataAtCell(fila, 5, data[fila][5]);
  hot.setDataAtCell(fila, 6, data[fila][6]);
  hot.setDataAtCell(fila, 7, data[fila][7]);
  hot.setDataAtCell(fila, 8, data[fila][8]);
  hot.setDataAtCell(fila, 9, data[fila][9]);
  hot.setDataAtCell(fila, 10, data[fila][10]);
  hot.setDataAtCell(fila, 11, data[fila][11]);
  hot.setDataAtCell(fila, 12, data[fila][12]);
  hot.setDataAtCell(fila, 14, data[fila][13]);
  hot.setDataAtCell(fila, 15, data[fila][14]);
  hot.setDataAtCell(fila, 16, data[fila][15]);
  hot.setDataAtCell(fila, 17, data[fila][16]);
  hot.setDataAtCell(fila, 18, data[fila][17]);
  hot.setDataAtCell(fila, 19, data[fila][18]);
  hot.setDataAtCell(fila, 20, data[fila][19]);
  hot.setDataAtCell(fila, 21, data[fila][20]);
  fila++;
})


function crearTabla () {
  hot = new Handsontable(grid, {
    data: data,
    minSpareRows: 1,
    colHeaders: true,
    rowHeaders: true,
    fixedRowsTop: 0,
    startCols: 4,
    stretchH: "all",
    contextMenu: [],
    colHeaders: ['Seccion', 'Hoja', 'Det', 'Sub-Det', 'Clave', 'Descripcion', 'kg/m', 'kg/pzs', 'cant', 'long', 'scrap', 'Peso total', 'Precio kg/pza', 'Subtotal', 'Cut & Fit','NC Mach','Conventional Mach','Welding','Finishing','Assy / Packing','Laser Service','Installation'],
    columns: [
      {data:'seccion',type: 'dropdown',
        source: ['COMERCIAL PARTS', 'EXTERNAL SERVICES', 'MATERIAL', 'LABOR']
      },
      {data:'hoja',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'det',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'subDet',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'clave'},
      {data:'descripcionCorta',readOnly: false},
      {data:'kgm',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'kgpzs',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'cant',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'long',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'scrap',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'pesoTotal',readOnly: false, type: 'numeric', format: '0,0.000', language: 'en'},
      {data:'precio', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'subTotal', type: 'numeric', format: '0,0.000', language: 'en', readOnly: true},
      {data:'cutFit', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'ncMach', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'conventionalMach', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'welding', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'finishing', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'assyPacking', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'laserService', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false},
      {data:'installation', type: 'numeric', format: '0,0.000', language: 'en', readOnly: false}
    ], 
    afterChange: function (changes, source) {
      if ((source == 'edit' || source == 'paste')) {
        if (changes[0][1] == "clave") {
          if (changes[0][3] == "@@") {
            hot.setDataAtCell(changes[0][0], 5, 'Producto personalizado')
            hot.setDataAtCell(changes[0][0], 8, '1.00')
            hot.setDataAtCell(changes[0][0], 12, '1.00')
          } else {
            var cve = changes[0][3];
            if (typeof cve === 'undefined') {
              return;
            }
            if (cve.trim() != '' || cve.trim() != '@@') {
              sincco.consumirAPI('POST', '{{constant("BASE_URL")}}gonzalez/proyectos/apiProducto', { data: cve.trim() })
              .done(function(data) {
                if (data.length) {
                  hot.setDataAtCell(changes[0][0], 5, data[0].DESCR)
                  hot.setDataAtCell(changes[0][0], 12, data[0].PRECIO)
                  hot.setDataAtCell(changes[0][0], 6, data[0].KGMETRO)
                  hot.setDataAtCell(changes[0][0], 7, data[0].KGPC)
                } else {
                  hot.setDataAtCell(changes[0][0], 5, 'NO EXISTE')
                  toastr.error('El producto no existe.', 'Intenta de nuevo')
                }
              }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log(errorThrown)
              })
            }
          }
        }

        if (changes[0][1] == "pesoTotal" || changes[0][1] == "precio") {
          hot.setDataAtCell(changes[0][0], 13, parseFloat(hot.getDataAtCell(changes[0][0], 11)) * parseFloat(hot.getDataAtCell(changes[0][0], 12)))
        }

        if (changes[0][1] == "kgm" || changes[0][1] == "kgpzs" || changes[0][1] == "cant" || changes[0][1] == "long" || changes[0][1] == "scrap") {
          if (parseFloat(hot.getDataAtCell(changes[0][0], 6)) > 0) {
            hot.setDataAtCell(changes[0][0], 11, (parseFloat(hot.getDataAtCell(changes[0][0], 6)) * parseFloat(hot.getDataAtCell(changes[0][0], 8))) * (1+(parseFloat(hot.getDataAtCell(changes[0][0], 10)) / 100)));
          } else {
            hot.setDataAtCell(changes[0][0], 11, (parseFloat(hot.getDataAtCell(changes[0][0], 7)) * parseFloat(hot.getDataAtCell(changes[0][0], 8))) * (1+(parseFloat(hot.getDataAtCell(changes[0][0], 10)) / 100)));
          }
        }
        actualizarTotales();
      }
    }
  })

  hot.updateSettings({
    beforeKeyDown: function (e) {
      var selection = hot.getSelected()
      if (e.keyCode == 113) {
        $('#fila-actual').val(selection[0])
        loader.show()
        e.preventDefault()
        lastChange = null
        e.stopImmediatePropagation();
        $('#tabla-productos').bootstrapTable({
          method: 'get',
          url: '{{constant('BASE_URL')}}gonzalez/proyectos/apiProductos',
          columns: [{ field:'CVE_ART', title:'Clave' }, { field:'DESCR', title:'Descripcion' }, { field:'UNI_MED', title:'Unidad' }],
          height: 300,
          striped: true,
          pagination: true,
          pageSize: 50,
          pageList: [50, 100, 200],
          search: true,
          showColumns: true,
          showRefresh: true,
          showExport: true,
          mobileResponsive: true,
          minimumCountColumns: 2
        })
        $('#modal').modal('show')
        loader.hide()
      }
    }
  })
}

function guardar(idProyecto) {
  loader.show()
  sincco.consumirAPI('POST',BASE_URL + 'gonzalez/proyectos/cotiza', { data: [{idProyecto: idProyecto, productos: hot.getData() }] })
  .done(function(data) {
    if (data.respuesta) {
      hot.loadData([])
      toastr.success('Cotización asignada a la tarea.', 'Éxito');
      $.redirect(BASE_URL + 'gonzalez/proyectos',{idProyecto:$('#idProyecto').val()}, 'POST');
      loader.hide()
    } else {
       toastr.error('Hubo un error al guardar los datos.', 'Intenta de nuevo');
       loader.hide()
     }
  }).fail(function(jqXHR, textStatus, errorThrown) {
    console.log('Error',errorThrown)
    loader.hide()
  })
}

$('#tabla-productos').on('dbl-click-row.bs.table', function (row, element) {
  hot.setDataAtCell($('#fila-actual').val(), 4, element.CVE_ART)
  $('#modal').modal('hide')
})

function actualizarTotales() {
  var result = [];
  result['cutFit'] = 0;
  result['ncMach'] = 0;
  result['conventionalMach'] = 0;
  result['welding'] = 0;
  result['finishing'] = 0;
  result['assyPacking'] = 0;
  result['laserService'] = 0;
  result['installation'] = 0;
  $(hot.getSourceData()).each(function(){
    if ($.isNumeric(this.cutFit)){ result['cutFit'] += this.cutFit; }
    if ($.isNumeric(this.ncMach)){ result['ncMach'] += this.ncMach; }
    if ($.isNumeric(this.conventionalMach)){ result['conventionalMach'] += this.conventionalMach; }
    if ($.isNumeric(this.welding)){ result['welding'] += this.welding; }
    if ($.isNumeric(this.finishing)){ result['finishing'] += this.finishing; }
    if ($.isNumeric(this.assyPacking)){ result['assyPacking'] += this.assyPacking; }
    if ($.isNumeric(this.laserService)){ result['laserService'] += this.laserService; }
    if ($.isNumeric(this.installation)){ result['installation'] += this.installation; }
  });
  
  $('.cutFit').html(result['cutFit']);
  $('.ncMach').html(result['ncMach']);
  $('.conventionalMach').html(result['conventionalMach']);
  $('.welding').html(result['welding']);
  $('.finishing').html(result['finishing']);
  $('.assyPacking').html(result['assyPacking']);
  $('.laserService').html(result['laserService']);
  $('.installation').html(result['installation']);  
}
</script>
{% include 'footer.html' %}